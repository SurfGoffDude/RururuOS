# Maintainer: RururuOS Team
# RururuOS PREEMPT_RT Kernel Package

pkgbase=linux-rururu-rt
pkgname=('linux-rururu-rt' 'linux-rururu-rt-headers')
pkgver=6.6.0
_rtver=rt15
pkgrel=1
pkgdesc="Linux kernel with PREEMPT_RT patches for RururuOS"
arch=('x86_64')
url="https://github.com/user/RururuOS"
license=('GPL2')
makedepends=('bc' 'cpio' 'gettext' 'libelf' 'pahole' 'perl' 'python' 'tar' 'xz' 'graphviz' 'imagemagick')
options=('!strip')

_srcname=linux-${pkgver}

source=(
    "https://cdn.kernel.org/pub/linux/kernel/v6.x/${_srcname}.tar.xz"
    "https://cdn.kernel.org/pub/linux/kernel/projects/rt/6.6/patch-${pkgver}-${_rtver}.patch.xz"
    "config"
)

sha256sums=(
    'SKIP'
    'SKIP'
    'SKIP'
)

prepare() {
    cd $_srcname

    echo "Applying PREEMPT_RT patch..."
    patch -Np1 -i "${srcdir}/patch-${pkgver}-${_rtver}.patch"

    echo "Setting config..."
    cp "${srcdir}/config" .config

    # Apply RururuOS specific options
    scripts/config --enable PREEMPT_RT
    scripts/config --set-val HZ 1000
    scripts/config --enable HIGH_RES_TIMERS
    scripts/config --enable NO_HZ_FULL
    scripts/config --enable IRQ_FORCED_THREADING
    scripts/config --disable DEBUG_PREEMPT
    scripts/config --disable TRANSPARENT_HUGEPAGE

    make olddefconfig

    # Set localversion
    echo "-rururu-rt" > localversion
}

build() {
    cd $_srcname
    make -j$(nproc) all
}

_package() {
    pkgdesc="The Linux kernel with PREEMPT_RT for RururuOS"
    depends=('coreutils' 'kmod' 'initramfs')
    optdepends=('linux-firmware: firmware images needed for some devices')
    provides=("linux=${pkgver}" "VIRTUALBOX-GUEST-MODULES" "WIREGUARD-MODULE")
    replaces=()

    cd $_srcname
    local modulesdir="$pkgdir/usr/lib/modules/$(<version)"

    echo "Installing boot image..."
    install -Dm644 "$(make -s image_name)" "$modulesdir/vmlinuz"

    # Used by mkinitcpio to name the kernel
    echo "$pkgbase" | install -Dm644 /dev/stdin "$modulesdir/pkgbase"

    echo "Installing modules..."
    make INSTALL_MOD_PATH="$pkgdir/usr" INSTALL_MOD_STRIP=1 modules_install

    # Remove build link
    rm -f "$modulesdir/build"
}

_package-headers() {
    pkgdesc="Headers and scripts for building modules for Linux PREEMPT_RT kernel"
    depends=("pahole")

    cd $_srcname
    local builddir="$pkgdir/usr/lib/modules/$(<version)/build"

    echo "Installing build files..."
    install -Dt "$builddir" -m644 .config Makefile Module.symvers System.map \
        localversion version vmlinux
    install -Dt "$builddir/kernel" -m644 kernel/Makefile
    install -Dt "$builddir/arch/x86" -m644 arch/x86/Makefile
    cp -t "$builddir" -a scripts

    echo "Installing headers..."
    cp -t "$builddir" -a include
    cp -t "$builddir/arch/x86" -a arch/x86/include
    install -Dt "$builddir/arch/x86/kernel" -m644 arch/x86/kernel/asm-offsets.s

    install -Dt "$builddir/drivers/md" -m644 drivers/md/*.h
    install -Dt "$builddir/net/mac80211" -m644 net/mac80211/*.h

    # Needed for external modules
    install -Dt "$builddir/drivers/gpu/drm/amd/display/dc" -m644 \
        drivers/gpu/drm/amd/display/dc/*.h
    install -Dt "$builddir/drivers/gpu/drm/amd/display/dc/inc" -m644 \
        drivers/gpu/drm/amd/display/dc/inc/*.h
    install -Dt "$builddir/drivers/gpu/drm/amd/include/asic_reg" -m644 \
        drivers/gpu/drm/amd/include/asic_reg/*.h
    install -Dt "$builddir/drivers/gpu/drm/amd/include" -m644 \
        drivers/gpu/drm/amd/include/*.h

    # Kconfig files
    find . -name 'Kconfig*' -exec install -Dm644 {} "$builddir/{}" \;

    # Remove unneeded architectures
    local arch
    for arch in "$builddir"/arch/*/; do
        [[ $arch = */x86/ ]] && continue
        rm -r "$arch"
    done

    # Remove documentation
    rm -r "$builddir/Documentation"

    # Remove broken symlinks
    find -L "$builddir" -type l -delete

    # Remove loose objects
    find "$builddir" -type f -name '*.o' -delete

    # Strip scripts
    local file
    while read -rd '' file; do
        case "$(file -Sib "$file")" in
            application/x-sharedlib\;*)
                strip -v $STRIP_SHARED "$file" ;;
            application/x-archive\;*)
                strip -v $STRIP_STATIC "$file" ;;
            application/x-executable\;*)
                strip -v $STRIP_BINARIES "$file" ;;
        esac
    done < <(find "$builddir" -type f -perm -u+x ! -name vmlinux -print0)

    # Strip vmlinux
    strip -v $STRIP_STATIC "$builddir/vmlinux"

    echo "Adding symlink..."
    mkdir -p "$pkgdir/usr/src"
    ln -sr "$builddir" "$pkgdir/usr/src/$pkgbase"
}

pkgname=("${pkgbase}" "${pkgbase}-headers")
for _p in "${pkgname[@]}"; do
    eval "package_$_p() {
        $(declare -f "_package${_p#$pkgbase}")
        _package${_p#$pkgbase}
    }"
done
